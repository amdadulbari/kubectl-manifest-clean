name: release

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            arch: amd64
          - os: ubuntu-22.04-arm
            platform: linux
            arch: arm64
          # darwin/arm64 only; macos-12 (darwin/amd64) deprecated, long queue times
          - os: macos-14
            platform: darwin
            arch: arm64
          - os: windows-latest
            platform: windows
            arch: amd64
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Build with PyInstaller
        run: pyinstaller -F -n kubectl-manifest-clean -p . entrypoint/manifest_clean/main.py

      - name: Prepare archive (Linux/macOS)
        if: matrix.platform != 'windows'
        run: |
          VERSION="${{ github.ref_name }}"
          mkdir -p staging
          cp dist/kubectl-manifest-clean staging/
          cp LICENSE staging/
          cd staging
          tar czvf "../kubectl-manifest-clean_${VERSION}_${{ matrix.platform }}_${{ matrix.arch }}.tar.gz" .
          cd ..

      - name: Prepare archive (Windows)
        if: matrix.platform == 'windows'
        run: |
          $v = "${{ github.ref_name }}"
          $zipName = "kubectl-manifest-clean_${v}_windows_amd64.zip"
          $zipPath = Join-Path $env:GITHUB_WORKSPACE $zipName
          New-Item -ItemType Directory -Path staging -Force
          Copy-Item dist/kubectl-manifest-clean.exe staging/
          Copy-Item LICENSE staging/
          Push-Location staging
          Compress-Archive -Path * -DestinationPath $zipPath -Force
          Pop-Location
          if (-not (Test-Path $zipPath)) { throw "Zip not created: $zipPath" }
          Get-Item $zipPath

      - name: Upload artifact (Linux/macOS)
        if: matrix.platform != 'windows'
        uses: actions/upload-artifact@v4
        with:
          name: pkg_${{ matrix.platform }}_${{ matrix.arch }}
          path: kubectl-manifest-clean_${{ github.ref_name }}_${{ matrix.platform }}_${{ matrix.arch }}.tar.gz

      - name: Upload artifact (Windows)
        if: matrix.platform == 'windows'
        uses: actions/upload-artifact@v4
        with:
          name: pkg_windows_amd64
          path: kubectl-manifest-clean_${{ github.ref_name }}_windows_amd64.zip

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Gather release assets
        run: |
          VERSION="${{ github.ref_name }}"
          mkdir -p release
          echo "--- Artifact dirs ---"
          ls -la artifacts/
          for dir in artifacts/*/; do
            echo "Copying from $dir"
            for f in "$dir"*.tar.gz "$dir"*.zip; do
              [ -f "$f" ] && cp -v "$f" release/
            done
          done
          echo "--- Release files before checksums ---"
          ls -la release/
          cd release
          for f in *.tar.gz *.zip; do
            [ -f "$f" ] && sha256sum "$f" >> checksums.txt
          done
          cat checksums.txt
          echo "--- Release files ---"
          ls -la
          [ -f "kubectl-manifest-clean_${VERSION}_windows_amd64.zip" ] || { echo "ERROR: Windows zip missing"; exit 1; }

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false
          files: release/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
